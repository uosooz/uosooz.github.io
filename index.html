<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<!-- TODO: Meta tags for Discord embedding? -->
<!-- TODO: Viewport tags for mobile -->
<title></title>
<!-- TODO: Move style to .css file -->
<style type="text/css">
body
{
	background-color: #333;
	color: #FFF;
}

#mapcanvas
{
	width: 640px;
	height: 512px;
	background-color: #fff;
	border: 1px solid #000;
	position: relative;
	left: 0px;
	top: 0px;
}

.mapmarker
{
	position: absolute;
	width: 100px;
	text-align: center;
	color: #000;
}

#footer
{
	margin-top: 25px;
	font-size: 0.9em;
}
</style>
<!-- TODO: Move script to .js file -->
<script type="text/javascript">
var moongates = [
	{ name: "Britain", gateID: 0, xLoc: 1336, yLoc: 1997 },
	{ name: "Moonglow", gateID: 1, xLoc: 4467, yLoc: 1283 },
	{ name: "Magincia", gateID: 2, xLoc: 3563, yLoc: 2139 },
	{ name: "Skara Brae", gateID: 3, xLoc: 643, yLoc: 2067 },
	{ name: "Trinsic", gateID: 4, xLoc: 1828, yLoc: 2948 },
	{ name: "Minoc / Vesper", gateID: 5, xLoc: 2701, yLoc: 692 },
	{ name: "Yew", gateID: 6, xLoc: 771, yLoc: 752 },
	{ name: "Jhelom", gateID: 7, xLoc: 1499, yLoc: 3771 }
];

const worldStart = new Date( Date.UTC( 1997, 8, 1, 0, 0, 0 ) ); // September 1, 1997 (Date.UTC's month argument is 0-based)
const msPerUOMinute = 5000;

function getGameTime( utcNow, xLoc )
{
	const elapsedMs = utcNow - worldStart;
	
	var totalMinutes = elapsedMs / msPerUOMinute;
	
	//totalMinutes += mapIndex * 320;
	totalMinutes += Math.floor( xLoc / 16 );
	
	const totalMinutesInt = Math.floor( totalMinutes );
	const hours = Math.floor( totalMinutesInt / 60 ) % 24;
	const mins = totalMinutesInt % 60;
	
	return [ totalMinutes, hours, mins ];
}

function formatTime( hours, mins )
{
	const isAM = ( hours < 12 );
	
	if ( hours == 0 )
		hours = 12;
	else if ( hours > 12 )
		hours -= 12;
	
	return hours + ":" + ( mins < 10 ? "0" + mins : mins ) + ( isAM ? " AM" : " PM" );
}

const stepMins = [ 0, 8, 28, 38, 58, 68, 88, 98, 118 ];

function getSteps( totalMinutes, hours, mins )
{
	const minsPast2h = ( hours % 2 ) * 60 + mins;
	var result = 0;
	
	for ( var i = stepMins.length - 1; i >= 0; --i )
	{
		if ( minsPast2h >= stepMins[i] )
		{
			result = i;
			break;
		}
	}
	
	result %= 8;
	
	// Time until next
	const nextStepMins = stepMins[result + 1];
	var minsUntilNext = nextStepMins - minsPast2h;
	
	if ( minsUntilNext < 0 )
		minsUntilNext += 120;
	
	const totalMinutesNext = Math.floor( totalMinutes ) + minsUntilNext;
	const minsUntilNextReal = totalMinutesNext - totalMinutes;
	const realSecUntilNext = Math.ceil( minsUntilNextReal * msPerUOMinute / 1000 );
	
	return [ result, realSecUntilNext ];
}

function getAllTimers( utcNow, moongate, orderByNext )
{
	const [ totalMinutes, hours, mins ] = getGameTime( utcNow, moongate.xLoc );
	const minsPast2h = ( hours % 2 ) * 60 + mins;
	var steps = 0;
	
	for ( var i = stepMins.length - 1; i >= 0; --i )
	{
		if ( minsPast2h >= stepMins[i] )
		{
			steps = i;
			break;
		}
	}
	
	steps %= 8;
	
	const minsPast2hReal = totalMinutes % 120;
	const showInTitle = document.getElementById( "singleInTitle" ).checked;
	
	var curDest = null;
	var nextDestTime = 0;
	
	if ( orderByNext )
	{
		for ( var i = 0; i < 8; ++i )
		{
			const moongateDest = moongates[( moongate.gateID + steps ) % moongates.length];
			
			document.getElementById( "dest" + i + "_name" ).innerHTML = moongateDest.name;
			
			if ( i == 0 )
			{
				document.getElementById( "dest" + i + "_time" ).innerHTML = "(Current destination)";
				
				curDest = moongateDest;
			}
			else
			{
				var goal = stepMins[steps];
				
				if ( goal < minsPast2hReal )
					goal += 120;
				
				const timeUntil = goal - minsPast2hReal;
				const realTimeUntil = Math.ceil( timeUntil * msPerUOMinute / 1000 );
				
				if ( i == 1 )
					nextDestTime = realTimeUntil;
				
				document.getElementById( "dest" + i + "_time" ).innerHTML = realTimeUntil + "s";
			}
			
			steps = ( steps + 1 ) % stepMins.length;
			
			if ( steps == 0 )
				steps = 1;
		}
	}
	else
	{
		for ( var i = 0; i < moongates.length; ++i )
		{
			const moongateDest = moongates[i];
			
			if ( firstRun )
				document.getElementById( "dest" + i + "_name" ).innerHTML = moongateDest.name;
			
			const destSteps = ( moongateDest.gateID - moongate.gateID + moongates.length ) % moongates.length;
			
			if ( destSteps == steps )
			{
				document.getElementById( "dest" + i + "_time" ).innerHTML = "(Current destination)";
				
				curDest = moongateDest;
			}
			else
			{
				var goal = ( destSteps == 0 ) ? stepMins[stepMins.length - 1] : stepMins[destSteps];
				
				if ( goal < minsPast2hReal )
					goal += 120;
				
				const timeUntil = goal - minsPast2hReal;
				const realTimeUntil = Math.ceil( timeUntil * msPerUOMinute / 1000 );
				
				if ( destSteps == ( steps + 1 ) % moongates.length )
					nextDestTime = realTimeUntil;
				
				document.getElementById( "dest" + i + "_time" ).innerHTML = realTimeUntil + "s";
			}
		}
	}
	
	if ( showInTitle )
		document.title = moongate.name + "→" + curDest.name + " ⏱ " + nextDestTime + "s";
}

var firstRun = true;

function doUpdate()
{
	const utcNow = new Date().getTime();
	
	for ( var i = 0; i < moongates.length; ++i )
	{
		const moongate = moongates[i];
		const [ totalMinutes, hours, mins ] = getGameTime( utcNow, moongate.xLoc );
		const [ steps, realSecUntilNext ] = getSteps( totalMinutes, hours, mins );
		const moongateDest = moongates[( moongate.gateID + steps ) % moongates.length];
		const nextMoongate = moongates[( moongate.gateID + steps + 1 ) % moongates.length];
		
		if ( firstRun )
		{
			document.getElementById( "mg" + i + "_name" ).innerHTML = moongate.name;
			
			// Map marker
			document.getElementById( "mapmg" + i ).style.left = Math.floor( moongate.xLoc / 8 ) - 50 + "px";
			document.getElementById( "mapmg" + i ).style.top = Math.floor( moongate.yLoc / 8 ) - 5 + "px";
		}
		
		if ( !moongate.lastDestination || moongate.lastDestination != moongateDest.gateID )
		{
			document.getElementById( "mg" + i + "_dest" ).innerHTML = moongateDest.name;
			
			// Map marker
			document.getElementById( "mapmg" + i ).innerHTML = "⭕<br>→" + moongateDest.name;
			
			moongate.lastDestination = moongateDest.gateID;
		}
		
		document.getElementById( "mg" + i + "_next" ).innerHTML = nextMoongate.name + " (" + realSecUntilNext + "s)";
	}
	
	if ( firstRun )
	{
		for ( var i = 0; i < moongates.length; ++i )
			document.getElementById( "selectsingle" + i ).innerHTML = moongates[i].name;
	}
	
	const selectedSingle = document.getElementById( "selectsingle" ).value;
	
	getAllTimers( utcNow, moongates[selectedSingle], true );
	
	firstRun = false;
}

var intervalID = -1;

function startUpdate()
{
	doUpdate();
	
	if ( intervalID == -1 )
		intervalID = setInterval( "doUpdate()", 1000 );
}

function stopUpdate()
{
	if ( intervalID != -1 )
		clearInterval( intervalID );

	intervalID = -1;
}

function changeAutoUpdate()
{
	if ( document.getElementById( "autoUpdate" ).checked )
		startUpdate();
	else
		stopUpdate();
}

function resetCheckbox()
{
	document.getElementById( "autoUpdate" ).checked = "checked";
}
</script>
</head>
<body onload="startUpdate(); resetCheckbox()">
<div id="header">
<h1>UO Siege Perilous Moongate Monitor</h1>
</div>
<div id="settings">
	<label><input type="checkbox" id="autoUpdate" checked="checked" onchange="changeAutoUpdate()"> Auto update</label>
	&middot;
	<input type="button" onclick="doUpdate()" value="Update now">
	&middot;
	<label><input type="checkbox" id="singleInTitle" onchange="doUpdate()"> Show single view in window title</label>
	<!-- TODO: Save settings in cookie? Only if manually saved by user? "This will store the current settings in a cookie in your browser. Continue?" -->
</div>
<div id="overview">
<h2>Overview</h2>
<table>
<tr>
<th>Moongate</th>
<th>Destination</th>
<th>Next</th>
</tr>
<tr>
<td id="mg0_name"></td>
<td id="mg0_dest"></td>
<td id="mg0_next"></td>
</tr>
<tr>
<td id="mg1_name"></td>
<td id="mg1_dest"></td>
<td id="mg1_next"></td>
</tr>
<tr>
<td id="mg2_name"></td>
<td id="mg2_dest"></td>
<td id="mg2_next"></td>
</tr>
<tr>
<td id="mg3_name"></td>
<td id="mg3_dest"></td>
<td id="mg3_next"></td>
</tr>
<tr>
<td id="mg4_name"></td>
<td id="mg4_dest"></td>
<td id="mg4_next"></td>
</tr>
<tr>
<td id="mg5_name"></td>
<td id="mg5_dest"></td>
<td id="mg5_next"></td>
</tr>
<tr>
<td id="mg6_name"></td>
<td id="mg6_dest"></td>
<td id="mg6_next"></td>
</tr>
<tr>
<td id="mg7_name"></td>
<td id="mg7_dest"></td>
<td id="mg7_next"></td>
</tr>
</table>
</div>
<div id="single">
<h2>Single View</h2>
<table>
<tr>
<th colspan="2">
<select id="selectsingle" onchange="doUpdate()">
<option id="selectsingle0" value="0"></option>
<option id="selectsingle1" value="1"></option>
<option id="selectsingle2" value="2"></option>
<option id="selectsingle3" value="3"></option>
<option id="selectsingle4" value="4"></option>
<option id="selectsingle5" value="5"></option>
<option id="selectsingle6" value="6"></option>
<option id="selectsingle7" value="7"></option>
</select>
</th>
</tr>
<tr>
<th>Destination</th>
<th>Time until</th>
</tr>
<tr>
<td id="dest0_name"></td>
<td id="dest0_time"></td>
</tr>
<tr>
<td id="dest1_name"></td>
<td id="dest1_time"></td>
</tr>
<tr>
<td id="dest2_name"></td>
<td id="dest2_time"></td>
</tr>
<tr>
<td id="dest3_name"></td>
<td id="dest3_time"></td>
</tr>
<tr>
<td id="dest4_name"></td>
<td id="dest4_time"></td>
</tr>
<tr>
<td id="dest5_name"></td>
<td id="dest5_time"></td>
</tr>
<tr>
<td id="dest6_name"></td>
<td id="dest6_time"></td>
</tr>
<tr>
<td id="dest7_name"></td>
<td id="dest7_time"></td>
</tr>
</table>
</div>
<div id="mapview">
<h2>Map View</h2>
<div id="mapcanvas">
<div id="mapmg0" class="mapmarker"></div>
<div id="mapmg1" class="mapmarker"></div>
<div id="mapmg2" class="mapmarker"></div>
<div id="mapmg3" class="mapmarker"></div>
<div id="mapmg4" class="mapmarker"></div>
<div id="mapmg5" class="mapmarker"></div>
<div id="mapmg6" class="mapmarker"></div>
<div id="mapmg7" class="mapmarker"></div>
</div>
</div>
<div id="footer">
Note: Calculations are performed using your system time. If your system time is incorrect, results may vary.
</div>
</body>
</html>