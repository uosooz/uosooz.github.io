<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UO:SP Moongate Monitor</title>
<meta name="viewport" content="width=650, initial-scale=1">
<meta property="og:title" content="UO:SP Moongate Monitor">
<meta property="og:description" content="View the moongate destination cycles of UO:Siege Perilous in real-time.">
<meta property="og:image" content="https://uosooz.github.io/images/uosp_logo.png">
<!-- TODO: Move style to .css file -->
<style type="text/css">
body
{
	background-color: #333;
	color: #FFF;
}

#header > div
{
	display: inline-block;
	vertical-align: middle;
}

#splogo
{
	height: 50px;
	margin-right: 5px;
}

.settings
{
	margin-bottom: 10px;
}

table
{
	border: 2px solid #fff;
	border-collapse: collapse;
}

th, td
{
	text-align: left;
	padding: 5px;
}

th
{
	border: 2px solid #fff;
	background-color: rgba(0, 0, 0, 0.3);
}

td
{
	border: 1px solid #fff;
}

.smalltd
{
	font-size: 0.8em;
}

#mapCanvas
{
	width: 640px;
	height: 512px;
	background: #00314a url(images/felucca.png) 0 0 no-repeat;
	position: relative;
	left: 0px;
	top: 0px;
}

.mapmarker
{
	position: absolute;
	width: 100px;
	text-align: center;
	color: #fff;
	text-shadow: -1px -1px 1px #000, -1px 1px 1px #000, 1px -1px 1px #000, 1px 1px 1px #000;
}

a, a:visited, a:hover, a:active
{
	color: #fff;
}

input
{
	margin-top: 5px;
	margin-bottom: 5px;
}

#footer
{
	margin-top: 25px;
	font-size: 0.9em;
}
</style>
<!-- TODO: Move script to .js file -->
<script type="text/javascript">
var moongates = [
	{ name: "Britain", gateID: 0, xLoc: 1336, yLoc: 1997 },
	{ name: "Moonglow", gateID: 1, xLoc: 4467, yLoc: 1283 },
	{ name: "Magincia", gateID: 2, xLoc: 3563, yLoc: 2139 },
	{ name: "Skara Brae", gateID: 3, xLoc: 643, yLoc: 2067 },
	{ name: "Trinsic", gateID: 4, xLoc: 1828, yLoc: 2948 },
	{ name: "Minoc / Vesper", gateID: 5, xLoc: 2701, yLoc: 692 },
	{ name: "Yew", gateID: 6, xLoc: 771, yLoc: 752 },
	{ name: "Jhelom", gateID: 7, xLoc: 1499, yLoc: 3771 }
];

const worldStart = new Date( Date.UTC( 1997, 8, 1, 0, 0, 0 ) ); // September 1, 1997 (Date.UTC's month argument is 0-based)
const msPerUOMinute = 5000;

function getGameTime( utcNow, xLoc )
{
	const elapsedMs = utcNow - worldStart;
	
	var totalMinutes = elapsedMs / msPerUOMinute;
	
	//totalMinutes += mapIndex * 320;
	totalMinutes += Math.floor( xLoc / 16 );
	
	const totalMinutesInt = Math.floor( totalMinutes );
	const hours = Math.floor( totalMinutesInt / 60 ) % 24;
	const mins = totalMinutesInt % 60;
	
	return [ totalMinutes, hours, mins ];
}

function formatTime( hours, mins )
{
	const isAM = ( hours < 12 );
	
	if ( hours == 0 )
		hours = 12;
	else if ( hours > 12 )
		hours -= 12;
	
	return hours + ":" + ( mins < 10 ? "0" + mins : mins ) + ( isAM ? " AM" : " PM" );
}

const stepMins = [ 0, 8, 28, 38, 58, 68, 88, 98, 118 ];

function getSteps( totalMinutes, hours, mins )
{
	const minsPast2h = ( hours % 2 ) * 60 + mins;
	var result = 0;
	
	for ( var i = stepMins.length - 1; i >= 0; --i )
	{
		if ( minsPast2h >= stepMins[i] )
		{
			result = i;
			break;
		}
	}
	
	result %= 8;
	
	// Time until next
	const nextStepMins = stepMins[result + 1];
	var minsUntilNext = nextStepMins - minsPast2h;
	
	if ( minsUntilNext < 0 )
		minsUntilNext += 120;
	
	const totalMinutesNext = Math.floor( totalMinutes ) + minsUntilNext;
	const minsUntilNextReal = totalMinutesNext - totalMinutes;
	const realSecUntilNext = Math.ceil( minsUntilNextReal * msPerUOMinute / 1000 );
	
	return [ result, realSecUntilNext ];
}

function getAllTimers( utcNow, moongate, orderByNext )
{
	const [ totalMinutes, hours, mins ] = getGameTime( utcNow, moongate.xLoc );
	const minsPast2h = ( hours % 2 ) * 60 + mins;
	var steps = 0;
	
	for ( var i = stepMins.length - 1; i >= 0; --i )
	{
		if ( minsPast2h >= stepMins[i] )
		{
			steps = i;
			break;
		}
	}
	
	steps %= 8;
	
	const minsPast2hReal = totalMinutes % 120;
	const showInTitle = document.getElementById( "singleInTitle" ).checked;
	
	var curDest = null;
	var nextDestTime = 0;
	
	if ( orderByNext )
	{
		for ( var i = 0; i < 8; ++i )
		{
			const moongateDest = moongates[( moongate.gateID + steps ) % moongates.length];
			
			document.getElementById( "dest" + i + "_name" ).innerHTML = moongateDest.name;
			
			if ( i == 0 )
			{
				document.getElementById( "dest" + i + "_time" ).innerHTML = "(Currently active)";
				
				curDest = moongateDest;
			}
			else
			{
				var goal = stepMins[steps];
				
				if ( goal < minsPast2hReal )
					goal += 120;
				
				const timeUntil = goal - minsPast2hReal;
				const realTimeUntil = Math.ceil( timeUntil * msPerUOMinute / 1000 );
				
				if ( i == 1 )
					nextDestTime = realTimeUntil;
				
				document.getElementById( "dest" + i + "_time" ).innerHTML = formatWaitTime( realTimeUntil );
			}
			
			steps = ( steps + 1 ) % stepMins.length;
			
			if ( steps == 0 )
				steps = 1;
		}
	}
	else
	{
		for ( var i = 0; i < moongates.length; ++i )
		{
			const moongateDest = moongates[i];
			
			document.getElementById( "dest" + i + "_name" ).innerHTML = moongateDest.name;
			
			const destSteps = ( moongateDest.gateID - moongate.gateID + moongates.length ) % moongates.length;
			
			if ( destSteps == steps )
			{
				document.getElementById( "dest" + i + "_time" ).innerHTML = "(Currently active)";
				
				curDest = moongateDest;
			}
			else
			{
				var goal = ( destSteps == 0 ) ? stepMins[stepMins.length - 1] : stepMins[destSteps];
				
				if ( goal < minsPast2hReal )
					goal += 120;
				
				const timeUntil = goal - minsPast2hReal;
				const realTimeUntil = Math.ceil( timeUntil * msPerUOMinute / 1000 );
				
				if ( destSteps == ( steps + 1 ) % moongates.length )
					nextDestTime = realTimeUntil;
				
				document.getElementById( "dest" + i + "_time" ).innerHTML = formatWaitTime( realTimeUntil );
			}
		}
	}
	
	if ( showInTitle )
		document.title = moongate.name + "→" + curDest.name + " ⏱ " + nextDestTime + "s";
}

var selectedSingle = -1;

function setSelected( i )
{
	if ( i >= 0 && i < moongates.length )
	{
		selectedSingle = i;
		
		document.getElementById( "singleHead" ).innerHTML = moongates[i].name + " Moongate"
	}
	else
	{
		selectedSingle = -1;
	}
	
	doUpdate();
	
	document.getElementById( "detailed" ).style.display = ( selectedSingle >= 0 ) ? "inherit" : "none";
}

function formatWaitTime( seconds )
{
	if ( seconds >= 60 )
	{
		/*
		const minutes = Math.floor( seconds / 60 );
		seconds %= 60;
		
		if ( seconds == 0 )
			return minutes + " minute" + ( minutes == 1 ? "" : "s" );
		else
			return minutes + " minute" + ( minutes == 1 ? "" : "s" ) + ", " + seconds + " second" + ( seconds == 1 ? "" : "s" );
		*/
		
		const minutesRounded = Math.ceil( seconds / 60 );
		
		return minutesRounded + " minute" + ( minutesRounded == 1 ? "" : "s" );
	}
	else
	{
		return seconds + " second" + ( seconds == 1 ? "" : "s" );
	}
}

function doUpdate()
{
	const utcNow = new Date().getTime();
	
	for ( var i = 0; i < moongates.length; ++i )
	{
		const moongate = moongates[i];
		const [ totalMinutes, hours, mins ] = getGameTime( utcNow, moongate.xLoc );
		const [ steps, realSecUntilNext ] = getSteps( totalMinutes, hours, mins );
		const moongateDest = moongates[( moongate.gateID + steps ) % moongates.length];
		const nextMoongate = moongates[( moongate.gateID + steps + 1 ) % moongates.length];
		
		if ( !moongate.lastDestination || moongate.lastDestination != moongateDest.gateID )
		{
			document.getElementById( "mg" + i + "_dest" ).innerHTML = "→ " + moongateDest.name;
			
			// Map marker
			document.getElementById( "mapmg" + i + "_dest" ).innerHTML = "→ " + moongateDest.name;
			
			moongate.lastDestination = moongateDest.gateID;
		}
		
		document.getElementById( "mg" + i + "_next" ).innerHTML = nextMoongate.name + " in " + formatWaitTime( realSecUntilNext );
	}
	
	if ( selectedSingle >= 0 )
		getAllTimers( utcNow, moongates[selectedSingle], true );
}

var intervalID = -1;

function startUpdate()
{
	doUpdate();
	
	if ( intervalID == -1 )
		intervalID = setInterval( "doUpdate()", 1000 );
}

function stopUpdate()
{
	if ( intervalID != -1 )
		clearInterval( intervalID );

	intervalID = -1;
}

function changeAutoUpdate()
{
	if ( document.getElementById( "autoUpdate" ).checked )
		startUpdate();
	else
		stopUpdate();
}

function singleInTitleChanged( e )
{
	if ( e.checked )
		doUpdate();
	else
		document.title = "UO:SP Moongate Monitor"; // reset to default
}

function createElementWithId( tagName, id )
{
	var elem = document.createElement( tagName );
	elem.id = id;
	return elem;
}

function build()
{
	var target = null;
	var elem1 = null;
	var elem2 = null;
	
	// Fill Table View
	target = document.getElementById( "tableBody" );
	
	for ( var i = 0; i < moongates.length; ++i )
	{
		elem1 = document.createElement( "tr" );
		elem1.appendChild( elem2 = createElementWithId( "td", "mg" + i + "_name" ) );
		elem2.innerHTML = "<a href=\"#detailed\" onclick=\"setSelected( " + i + " )\">" + moongates[i].name + "</a>";
		elem1.appendChild( createElementWithId( "td", "mg" + i + "_dest" ) );
		elem1.appendChild( elem2 = createElementWithId( "td", "mg" + i + "_next" ) );
		elem2.className = "smalltd";
		target.appendChild( elem1 );
	}
	
	// Fill Map View
	target = document.getElementById( "mapCanvas" );
	
	for ( var i = 0; i < moongates.length; ++i )
	{
		elem1 = document.createElement( "div" );
		elem1.id = "mapmg" + i;
		elem1.className = "mapmarker";
		elem1.style.left = Math.floor( moongates[i].xLoc / 8 ) - 50 + "px";
		elem1.style.top = Math.floor( moongates[i].yLoc / 8 ) - 10 + "px";
		elem1.innerHTML = "<div><a href=\"#detailed\" onclick=\"setSelected( " + i + " )\"><img src=\"images/moongate.png\" alt=\"" + moongates[i].name + "\"></a></div><div id=\"mapmg" + i + "_dest\"></div>";
		target.appendChild( elem1 );
	}
	
	// Fill Detailed View
	target = document.getElementById( "singleBody" );
	
	for ( var i = 0; i < moongates.length; ++i )
	{
		elem1 = document.createElement( "tr" );
		elem1.appendChild( createElementWithId( "td", "dest" + i + "_name" ) );
		elem1.appendChild( createElementWithId( "td", "dest" + i + "_time" ) );
		target.appendChild( elem1 );
	}
	
	// Reset settings to default
	document.getElementById( "autoUpdate" ).checked = "checked";
	document.getElementById( "viewModeTable" ).checked = "checked";
	document.getElementById( "viewModeMap" ).checked = "";
}

function setViewMode( mode )
{
	document.getElementById( "overview" ).style.display = ( mode == 0 ) ? "inherit" : "none";
	document.getElementById( "mapView" ).style.display = ( mode == 1 ) ? "inherit" : "none";
}
</script>
</head>
<body onload="build(); startUpdate(); resetCheckbox()">

<div id="header">
<div>
<img id="splogo" src="images/uosp_logo.png">
</div>
<div>
<h1>UO:Siege Perilous Moongate Monitor</h1>
</div>
</div>

<div class="settings">
	<label><input type="checkbox" id="autoUpdate" checked="checked" onchange="changeAutoUpdate()"> Auto update</label>
	&middot;
	<input type="button" onclick="doUpdate()" value="Update now">
	<br>
	<label><input type="radio" id="viewModeTable" name="viewMode" value="0" onchange="setViewMode( 0 )" checked="checked"> Table View</label> <label><input type="radio" id="viewModeMap" name="viewMode" value="1" onchange="setViewMode( 1 )"> Map View</label>
</div>

<div id="overview">
<table width="640">
<thead>
<tr>
<th width="30%">Moongate</th>
<th width="30%">Destination</th>
<th width="40%">Upcoming</th>
</tr>
</thead>
<tbody id="tableBody">
</tbody>
</table>
</div>

<div id="mapView" style="display: none">
<div id="mapCanvas">
</div>
</div>

<div>
<p>Click on a moongate to see all upcoming destinations.</p>
</div>

<div id="detailed" style="display: none">
<h2 id="singleHead"></h2>
<div class="settings">
<input type="button" value="Close" onclick="setSelected( -1 )">
<label><input type="checkbox" id="singleInTitle" onchange="singleInTitleChanged( this )"> Show in window title</label>
</div>
<table width="320">
<thead>
<tr>
<th width="50%">Destination</th>
<th width="50%">Time until active</th>
</tr>
</thead>
<tbody id="singleBody">
</tbody>
</table>
</div>

<div id="footer">
<p>Calculations are performed using system time. Ensure your system time is correct for accurate results.</p>
</div>

</body>
</html>